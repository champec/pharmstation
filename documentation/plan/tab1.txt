

This is excellent brainstorming â€” you've got a really clear mental model of how this should work. Let me organize everything you've said, fill in the gaps, and propose a complete auth/user flow architecture. I'll also push back or suggest improvements where I think it's warranted.

---

## ğŸ—ï¸ Complete Architecture & Auth Design

### Tech Stack (Confirmed)

| Layer | Technology | Notes |
|-------|-----------|-------|
| **Frontend (Web)** | React 19 + Vite | Fast dev, latest features |
| **Frontend (Desktop)** | Tauri v2 | Wraps web frontend + Rust backend for offline |
| **Frontend (Mobile)** | React Native (latest stable) | Expo recommended for faster dev |
| **Backend** | Supabase | Auth, Postgres, Realtime, Storage, Edge Functions |
| **Hosting (Web)** | Vercel | Auto-deploy from repo |
| **AI** | Edge Functions â†’ LLM APIs | Invoice/prescription processing |
| **Storage** | Supabase Storage (S3 buckets) | Invoice images, prescription scans, attachments |

---

## ğŸ” Authorization Architecture

### The Two-Layer Login Model

This is your key differentiator for security. Think of it like a hospital badge system:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAYER 1                           â”‚
â”‚              Organisation Login                      â”‚
â”‚                                                     â”‚
â”‚  "Which pharmacy are you at?"                       â”‚
â”‚                                                     â”‚
â”‚  â€¢ Organisation code/ID                             â”‚
â”‚  â€¢ 2FA via pharmacy's dedicated device              â”‚
â”‚  â€¢ Geolocation check (is user at pharmacy?)         â”‚
â”‚  â€¢ Opens the "station" â€” you're in the pharmacy     â”‚
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    LAYER 2                           â”‚
â”‚                 User Login                           â”‚
â”‚                                                     â”‚
â”‚  "Who are you?"                                     â”‚
â”‚                                                     â”‚
â”‚  â€¢ Personal credentials OR short PIN (4-6 digit)    â”‚
â”‚  â€¢ Role-based access loads                          â”‚
â”‚  â€¢ Audit trail begins (everything tagged to user)   â”‚
â”‚  â€¢ Quick switch between users (shared computer)     â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why This Works

- **Shared computers** â€” pharmacies have 1-2 PCs shared by 5+ staff. The org stays logged in, users switch with PINs
- **Security** â€” even if someone gets a PIN, they can't use it outside the pharmacy (geolocation + 2FA device)
- **Audit trail** â€” every action is tagged to a specific user within a specific organisation session
- **Locums** â€” they have their own account, get granted access to an org, and use the same flow

---

## ğŸ‘¥ Entity Model

### Organisations (Pharmacies)

```
Organisation
â”œâ”€â”€ id (UUID)
â”œâ”€â”€ name ("Greenfield Pharmacy")
â”œâ”€â”€ gphc_premises_number
â”œâ”€â”€ address
â”œâ”€â”€ geolocation (lat/lng + radius)
â”œâ”€â”€ settings (JSON - configurable)
â”œâ”€â”€ subscription_tier
â”œâ”€â”€ created_by (us â€” PharmStation admin)
â”œâ”€â”€ owner_user_id (FK â†’ User)
â”‚
â”œâ”€â”€ Has ONE of each:
â”‚   â”œâ”€â”€ RP Log
â”‚   â”œâ”€â”€ CD Register
â”‚   â”œâ”€â”€ Patient Returns Log
â”‚   â”œâ”€â”€ Private CD Register
â”‚   â”œâ”€â”€ POM Register
â”‚   â”œâ”€â”€ SOP Library
â”‚   â”œâ”€â”€ Handover Board
â”‚   â””â”€â”€ Optional Logs (fridge, cleaning, etc.)
â”‚
â””â”€â”€ Has MANY:
    â”œâ”€â”€ Organisation Members (join table)
    â””â”€â”€ Invitations / Access Grants
```

### Users

```
User
â”œâ”€â”€ id (UUID â€” Supabase Auth)
â”œâ”€â”€ email
â”œâ”€â”€ full_name
â”œâ”€â”€ gphc_number (nullable â€” not all roles are registered)
â”œâ”€â”€ role_type_default (pharmacist | technician | dispenser | owner)
â”œâ”€â”€ phone
â”œâ”€â”€ created_at
â”‚
â””â”€â”€ Can belong to MANY organisations
    (with different permissions in each)
```

### Organisation Members (Join Table)

```
OrganisationMember
â”œâ”€â”€ id
â”œâ”€â”€ organisation_id (FK)
â”œâ”€â”€ user_id (FK)
â”œâ”€â”€ role (owner | manager | pharmacist | technician | dispenser | locum)
â”œâ”€â”€ permissions (JSONB â€” fully configurable overrides)
â”œâ”€â”€ pin_code (hashed â€” 4-6 digit for quick login)
â”œâ”€â”€ status (active | suspended | revoked)
â”œâ”€â”€ is_locum (boolean)
â”œâ”€â”€ approved_by (FK â†’ User)
â”œâ”€â”€ approved_at
â”œâ”€â”€ created_at
â””â”€â”€ last_active_at
```

---

## ğŸ›¡ï¸ Permissions System

### Default Role Templates (Starting Point)

These are just **defaults** â€” owners can override everything per user.

| Permission | Owner | Manager | Pharmacist | Technician | Dispenser | Locum |
|-----------|-------|---------|------------|------------|-----------|-------|
| **CD Register â€” Read** | âœ… | âœ… | âœ… | âœ… | âŒ | âœ… |
| **CD Register â€” Write** | âŒ* | âŒ | âœ… | âœ… | âŒ | âœ… |
| **CD Register â€” Correct** | âŒ | âŒ | âœ… | âŒ | âŒ | âœ… |
| **RP Log â€” Sign In/Out** | âœ… | âŒ | âœ… | âŒ | âŒ | âœ… |
| **RP Log â€” View** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **Patient Returns â€” Write** | âŒ | âŒ | âœ… | âœ… | âŒ | âœ… |
| **SOP Library â€” Upload** | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| **Handover Notes â€” All** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **Manage Users** | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| **Approve Locums** | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| **View Audit Trail** | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| **AI Scan â€” Use** | âœ… | âœ… | âœ… | âœ… | âŒ | âœ… |
| **Org Settings** | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| **Billing** | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |

*\*Owner defaults to read-only on CD register â€” can be enabled by the owner themselves*

### How Overrides Work

```typescript
// Default permissions come from role template
const defaultPerms = getRoleTemplate("technician");

// Owner can override specific permissions for a user
const memberPerms = {
  ...defaultPerms,
  ...member.permissions  // JSONB overrides from org_members table
};

// Example: Give a specific technician CD correction rights
member.permissions = {
  "cd_register.correct": true  // Override default false
};
```

---

## ğŸ”„ Login Flows

### Flow 1: Full Login (First Time / New Session)

```
User opens PharmStation
        â”‚
        â–¼
â”Œâ”€ Choose login type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                          â”‚
â”‚  [Organisation Login]  [Personal Login]  â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚               â”‚
               â–¼               â–¼
        Org Login Flow    Personal-Only Flow
               â”‚          (edit profile,
               â”‚           view your history)
               â–¼
    Enter Org Code/ID
               â”‚
               â–¼
    Geolocation Check â”€â”€â”€â”€ FAIL â†’ "You must be
               â”‚                   at the pharmacy"
               â”‚
               â–¼
    2FA via Pharmacy Device
    (Authenticator app on
     pharmacy tablet/eDOS)
               â”‚
               â–¼
    âœ… Org Session Active
    (shows user selection screen)
               â”‚
               â–¼
    Select Your Name / Enter PIN
    (4-6 digit quick code)
               â”‚
               â–¼
    âœ… Fully Authenticated
    Role permissions loaded
    Audit trail active
```

### Flow 2: Quick User Switch (Shared Computer)

```
Org is already logged in
        â”‚
        â–¼
User clicks "Switch User" or session times out
        â”‚
        â–¼
Shows user list for this org
        â”‚
        â–¼
User taps their name + enters 4-digit PIN
        â”‚
        â–¼
âœ… New user session
Previous user's session cleanly closed
Audit trail switches
```

### Flow 3: Locum Access Request

```
Locum pharmacist has a PharmStation account
        â”‚
        â–¼
Locum selects "Request Access to Pharmacy"
        â”‚
        â–¼
Enters Org Code or searches by name/GPhC premises number
        â”‚
        â–¼
Request sent to Org Owner/Manager
        â”‚
        â–¼
Owner/Manager approves (can set expiry date)
        â”‚
        â–¼
Locum can now log into that org
(same flow as regular staff)
        â”‚
        â–¼
Access persists until revoked
```

---

## ğŸ“± Platform-Specific Session Behaviour

| Behaviour | Web (Vite) | Desktop (Tauri) | Mobile (RN) |
|-----------|-----------|-----------------|--------------|
| **Org session** | Timeout after X mins inactivity | Stays logged in (persisted) | Timeout after X mins |
| **User session** | Timeout, requires PIN re-entry | Timeout, requires PIN | Timeout, requires PIN |
| **Geolocation** | Browser API | Optional (trusted device) | GPS |
| **2FA device** | Separate device needed | Can be the 2FA device itself | Can be the 2FA device |
| **Offline** | âŒ Not supported | âœ… Full offline mode | âš ï¸ Limited offline |
| **Auto-update** | Vercel (instant) | Tauri updater (built-in) | APK from website / OTA |

---

## ğŸ—„ï¸ Supabase Schema (High Level)

```sql
-- Organisations (we create these, not users)
CREATE TABLE organisations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  gphc_premises_number TEXT UNIQUE,
  address JSONB NOT NULL,
  geolocation GEOGRAPHY(POINT, 4326),
  geo_radius_meters INTEGER DEFAULT 100,
  settings JSONB DEFAULT '{}',
  subscription_tier TEXT DEFAULT 'base',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Users (extend Supabase Auth)
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  full_name TEXT NOT NULL,
  gphc_number TEXT,
  phone TEXT,
  default_role TEXT DEFAULT 'dispenser',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Organisation Members (join table with permissions)
CREATE TABLE organisation_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id UUID REFERENCES organisations(id),
  user_id UUID REFERENCES user_profiles(id),
  role TEXT NOT NULL DEFAULT 'dispenser',
  permissions JSONB DEFAULT '{}',
  pin_hash TEXT,  -- hashed 4-6 digit PIN
  status TEXT DEFAULT 'active',
  is_locum BOOLEAN DEFAULT FALSE,
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_active_at TIMESTAMPTZ,
  UNIQUE(organisation_id, user_id)
);

-- Sessions / Audit
CREATE TABLE org_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id UUID REFERENCES organisations(id),
  user_id UUID REFERENCES user_profiles(id),
  platform TEXT NOT NULL,  -- 'web' | 'desktop' | 'mobile'
  started_at TIMESTAMPTZ DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  geo_verified BOOLEAN DEFAULT FALSE,
  twofa_verified BOOLEAN DEFAULT FALSE
);

-- CD Register (one per org, entries are rows)
CREATE TABLE cd_registers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id UUID REFERENCES organisations(id) UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE cd_register_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  register_id UUID REFERENCES cd_registers(id),
  entry_number SERIAL,
  drug_name TEXT NOT NULL,
  form TEXT,
  strength TEXT,
  quantity_received NUMERIC,
  quantity_supplied NUMERIC,
  running_balance NUMERIC NOT NULL,
  patient_name TEXT,
  prescriber TEXT,
  date_of_transaction DATE NOT NULL,
  entered_by UUID REFERENCES user_profiles(id),
  source TEXT DEFAULT 'manual',  -- 'manual' | 'ai_scan' | 'ai_draft'
  scan_image_url TEXT,           -- link to stored invoice/script image
  prescription_image_url TEXT,   -- attached prescription scan
  is_correction BOOLEAN DEFAULT FALSE,
  corrects_entry_id UUID REFERENCES cd_register_entries(id),
  correction_reason TEXT,
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  -- NEVER DELETE â€” soft corrections only
  is_void BOOLEAN DEFAULT FALSE
);

-- RP Log (one per org)
CREATE TABLE rp_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id UUID REFERENCES organisations(id) UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE rp_log_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  log_id UUID REFERENCES rp_logs(id),
  pharmacist_id UUID REFERENCES user_profiles(id),
  signed_in_at TIMESTAMPTZ NOT NULL,
  signed_out_at TIMESTAMPTZ,
  gphc_number TEXT NOT NULL,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Scan attachments bucket reference
-- Images stored in Supabase Storage bucket: 'scan-attachments'
-- Path: {org_id}/{register_type}/{entry_id}/{filename}
```

---

## ğŸ”„ Offline Sync Strategy (Desktop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tauri Desktop  â”‚         â”‚     Supabase     â”‚
â”‚                  â”‚         â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  sync   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SQLite    â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”¼â”€â–ºâ”‚  Postgres  â”‚  â”‚
â”‚  â”‚  (local)   â”‚  â”‚         â”‚  â”‚  (cloud)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚         â”‚                  â”‚
â”‚  Works offline   â”‚         â”‚  Source of truth â”‚
â”‚  Queues changes  â”‚         â”‚  when online     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Sync rules:
1. Every entry has a created_at timestamp + client_id
2. When online: push local queue â†’ pull remote changes
3. Conflict resolution: last-write-wins with audit log
4. Images queued for upload when back online
5. Sync status indicator in UI (green/amber/red)
```

---

## ğŸ”„ Update Strategy

| Platform | Method | Mechanism |
|----------|--------|-----------|
| **Web** | Automatic | Vercel deploys on push to `main` |
| **Desktop** | Tauri built-in updater | Checks GitHub releases or custom endpoint |
| **Mobile (Phase 1)** | Manual APK | Download from `pharmstation.co.uk/download` |
| **Mobile (Phase 2)** | OTA updates | Expo Updates / CodePush |
| **Mobile (Phase 3)** | Store updates | Google Play / App Store |

---

## ğŸ“¸ AI Scan Flow (The Killer Feature)

```
Pharmacist receives CD delivery
        â”‚
        â–¼
Opens PharmStation â†’ CD Register â†’ "Quick Scan"
        â”‚
        â–¼
Takes photo of invoice with phone/tablet/webcam
        â”‚
        â–¼
Image uploaded to Supabase Storage
(permanently stored â€” this IS the record)
        â”‚
        â–¼
Edge Function sends to LLM (Vision API)
        â”‚
        â–¼
AI extracts: drug name, form, strength,
quantity, supplier, invoice number, date
        â”‚
        â–¼
Returns DRAFT entries (marked as "AI Draft")
        â”‚
        â–¼
Pharmacist reviews â†’ approves/edits â†’ confirms
        â”‚
        â–¼
Entry saved with:
- source: "ai_scan"
- scan_image_url: link to original photo
- approved_by: pharmacist who confirmed
        â”‚
        â–¼
Running balance updated automatically
```

**This means**: The original invoice image is permanently attached to the entry. If there's ever a query during an audit or reconciliation, you can pull up the exact photo. No other provider offers this.

---

## My Suggestions & Pushbacks

### 1. ğŸŸ¢ Geolocation â€” make it configurable, not mandatory
Some pharmacies may push back on mandatory location tracking. I'd suggest:
- **Default: ON** (recommended for compliance)
- **Configurable per org**: owner can disable if they accept the risk
- **Desktop exception**: if it's a fixed pharmacy PC, geolocation is less critical â€” the device itself is trusted

### 2. ğŸŸ¢ PIN length â€” go 4-6 digits, user choice
4 is fine for quick switching in a pharmacy. Let users choose their own length. Hash it properly (bcrypt).

### 3. ğŸŸ¡ Org creation â€” consider a self-service onboarding later
Starting with manual creation is smart (you control quality, build relationships). But plan the schema so you *could* add self-service signup later without rewriting everything.

### 4. ğŸŸ¢ Desktop "offline forever" concern
You mentioned pharmacies could theoretically use desktop offline and never pay. Some mitigations:
- License key that expires after 30 days without sync
- Feature degradation (AI features disabled offline obviously)
- Audit log watermark showing last sync date (regulators might ask about this)

### 5. ğŸŸ¢ Image storage costs
Invoice and prescription images will add up in storage. Plan for:
- Compressed uploads (client-side resize before upload)
- Tiered storage (recent images in hot storage, older in cold)
- Include a storage allowance in the Â£15/month (e.g., 5GB) with overage billing

---

Want me to **create a PR** that adds this entire architecture document to your `documentation/technical/` folder? Or shall we refine any of these flows first before committing them to the repo?

